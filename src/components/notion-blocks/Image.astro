---
import { Image as AstroImage } from 'astro:assets'
import { ENABLE_LIGHTBOX } from '../../server-constants.ts'
import * as interfaces from '../../lib/interfaces'
import { getImageFromNotionUrl } from '../../lib/image-helpers'
import Caption from './Caption.astro'
import ImageWithBlur from '../ImageWithBlur.astro'

export interface Props {
  block: interfaces.Block
}

const { block } = Astro.props

if (!block.Image) {
  return null
}

let imageModule: any = null
let imageUrl = ''
let altText = ''

// Extract alt text from caption
if (block.Image.Caption && block.Image.Caption.length > 0) {
  altText = block.Image.Caption
    .map((rt) => rt.PlainText || rt.Text?.Content || '')
    .join(' ')
    .trim()
}

if (!altText) {
  altText = 'Image in a image block'
}

// Handle External (remote) vs File (downloaded) images
if (block.Image.External) {
  imageUrl = block.Image.External.Url
} else if (block.Image.File) {
  if (import.meta.env.DEV) {
    // In dev, use URL directly
    imageUrl = block.Image.File.Url
  } else {
    // In production, use pre-loaded image map for optimized images
    const imported = getImageFromNotionUrl(new URL(block.Image.File.Url))
    if (imported) {
      imageModule = imported
    } else {
      // Fallback to URL if lookup fails
      imageUrl = block.Image.File.Url
    }
  }
}

const imageSrc = imageModule || imageUrl
const lightboxHref = imageModule ? (imageModule as any).src : imageUrl
---

<figure class="image">
  {
    imageSrc && (
      <div>
        <div class="image-wrapper">
          {ENABLE_LIGHTBOX ? (
            <a 
              data-fslightbox 
              href={lightboxHref} 
              data-type="image"
              class="lightbox-link"
            >
              <ImageWithBlur
                src={imageSrc}
                alt={altText}
                width={imageModule ? imageModule.width : block.Image.Width}
                height={imageModule ? imageModule.height : block.Image.Height}
                loading="lazy"
                class="notion-image"
              />
            </a>
          ) : (
            <ImageWithBlur
              src={imageSrc}
              alt={altText}
              width={imageModule ? imageModule.width : block.Image.Width}
              height={imageModule ? imageModule.height : block.Image.Height}
              loading="lazy"
              class="notion-image"
            />
          )}
        </div>
        <Caption richTexts={block.Image.Caption} />
      </div>
    )
  }
</figure>

<style>
  .image {
    display: flex;
    flex-direction: column;
    margin: 0.2rem auto 0;
  }
  .image > div {
    margin: 0 auto;
    width: 100%;
  }
  .image-wrapper {
    width: 100%;
  }
  .lightbox-link {
    display: block;
    width: 100%;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .lightbox-link:hover {
    opacity: 0.9;
  }
  .notion-image {
    width: 100%;
    max-width: 100%;
  }
</style>
