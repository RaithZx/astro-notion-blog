---
import { NUMBER_OF_POSTS_PER_PAGE } from '../server-constants.ts'
import {
  getPosts,
  getRankedPosts,
  getAllTags,
  getNumberOfPages,
  getFeaturedPost,
  getTopPosts,
} from '../lib/notion/client.ts'
import Layout from '../layouts/Layout.astro'
import NoContents from '../components/NoContents.astro'
import PostDate from '../components/PostDate.astro'
import PostTags from '../components/PostTags.astro'
import PostTitle from '../components/PostTitle.astro'
import PostFeaturedImage from '../components/PostFeaturedImage.astro'
import PostExcerpt from '../components/PostExcerpt.astro'
import ReadMoreLink from '../components/ReadMoreLink.astro'
import Pagination from '../components/Pagination.astro'
import BlogPostsLink from '../components/BlogPostsLink.astro'
import BlogTagsLink from '../components/BlogTagsLink.astro'
import { getPostLink } from '../lib/blog-helpers.ts'
import { filePath } from '../lib/blog-helpers.ts'

const labels = {
  categories: 'Kategorias',
}
const [posts, rankedPosts, tags, numberOfPages, featuredPost, topPosts] = await Promise.all([
  getPosts(NUMBER_OF_POSTS_PER_PAGE),
  getRankedPosts(),
  getAllTags(),
  getNumberOfPages(),
  getFeaturedPost(),
  getTopPosts(4),
])

// Helper function to format date as "12 Jul 2025"
function formatDateShort(date: string): string {
  const dt = new Date(date)
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
  const day = dt.getDate()
  const month = months[dt.getMonth()]
  const year = dt.getFullYear()
  return `${day} ${month} ${year}`
}

// Helper function to estimate reading time (words per minute = 200)
function estimateReadingTime(excerpt: string): string {
  const words = excerpt.split(/\s+/).length
  const minutes = Math.max(1, Math.ceil(words / 200))
  return `${minutes} min`
}
---

<Layout title="Ligadu" description="Artigus di siensia i saudi" path="/" ogImage="">
  <!-- Featured Section - Above main and aside -->
  {
    (featuredPost || topPosts.length > 0) && (
      <section slot="featured" class="mb-12 px-5 py-8 max-sm:px-2.5 max-sm:py-5" style="max-width: 1200px; margin: 0 auto;">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Main Featured Article -->
          {
            featuredPost && (
              <div class="lg:col-span-2">
                <a href={getPostLink(featuredPost.Slug)} class="block group">
                  <div class="relative overflow-hidden rounded-lg mb-4 aspect-[16/10] bg-slate-200">
                    {
                      featuredPost.FeaturedImage && featuredPost.FeaturedImage.Url ? (
                        <img 
                          src={import.meta.env.DEV ? featuredPost.FeaturedImage.Url : filePath(new URL(featuredPost.FeaturedImage.Url))} 
                          alt={featuredPost.Title}
                          class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                        />
                      ) : (
                        <div class="w-full h-full flex items-center justify-center bg-slate-300">
                          <svg class="w-16 h-16 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                          </svg>
                        </div>
                      )
                    }
                  </div>
                  <div class="space-y-3">
                    <div class="flex items-center gap-2 text-xs text-slate-500 uppercase tracking-wide">
                      <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded font-semibold">Sta Ligadu</span>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-900 group-hover:text-blue-600 transition-colors leading-tight">
                      {featuredPost.Title}
                    </h2>
                    <div class="flex items-center gap-1.5 text-sm text-slate-400">
                      {featuredPost.Date && (
                        <span>{formatDateShort(featuredPost.Date)}</span>
                      )}
                      {featuredPost.Tags && featuredPost.Tags.length > 0 && (
                        <>
                          <span>路</span>
                          <span>{featuredPost.Tags[0].name}</span>
                        </>
                      )}
                      {featuredPost.Excerpt && (
                        <>
                          <span>路</span>
                          <span>{estimateReadingTime(featuredPost.Excerpt)}</span>
                        </>
                      )}
                    </div>
                    {
                      featuredPost.Excerpt && (
                        <p class="text-slate-600 text-base leading-relaxed line-clamp-3">
                          {featuredPost.Excerpt}
                        </p>
                      )
                    }
                  </div>
                </a>
              </div>
            )
          }

          <!-- Top Stories -->
          {
            topPosts.length > 0 && (
              <div class="space-y-6">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Artigus distakadu</h3>
                {
                  topPosts.map((post) => (
                    <a href={getPostLink(post.Slug)} class="block group">
                      <div class="flex-1 min-w-0">
                        <h4 class="text-base font-bold text-slate-900 group-hover:text-blue-600 transition-colors leading-snug line-clamp-2 mb-1">
                          {post.Title}
                        </h4>
                        <div class="flex items-center gap-1.5 text-xs text-slate-500">
                          {post.Date && (
                            <span>{formatDateShort(post.Date)}</span>
                          )}
                          {post.Tags && post.Tags.length > 0 && (
                            <>
                              <span>路</span>
                              <span>{post.Tags[0].name}</span>
                            </>
                          )}
                          {post.Excerpt && (
                            <>
                              <span>路</span>
                              <span>{estimateReadingTime(post.Excerpt)}</span>
                            </>
                          )}
                        </div>
                      </div>
                    </a>
                  ))
                }
              </div>
            )
          }
        </div>
      </section>
    )
  }

  <div slot="main" class="" style="max-width: 100%;">
  <!-- <div slot="main" class="bg-white rounded-lg p-0 shadow-sm"> -->

    {
      posts.length === 0 ? (
        <NoContents contents={posts} />
      ) : (
        <div class="p-0" style="max-width: 100%; margin-left: -1.25rem; margin-right: -1.25rem;">
          <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6 px-5">Kes 煤ltimu artigu i st贸ria</h3>
          {posts.map((post, index) => (
            <article class="flex gap-4 py-4 px-5 transition-colors last:border-b-0 max-sm:flex-col max-sm:gap-3 max-sm:py-4 max-sm:px-4 cursor-pointer hover:bg-slate-50">
              {post.FeaturedImage && post.FeaturedImage.Url && (
                <div class="w-32 aspect-[4/5] rounded-md overflow-hidden bg-slate-200 max-sm:w-full max-sm:aspect-video">
                  <PostFeaturedImage post={post} />
                </div>
              )}
              <div class="flex-1 min-w-0 flex flex-col justify-between">
                <div>
                  <h1 class="m-0 text-lg font-bold text-slate-900 leading-tight hover:text-blue-600 transition-colors">
                    <PostTitle post={post} enableLink={true} />
                  </h1>
                  <div class="flex items-center gap-1.5 text-xs text-slate-500 mt-1">
                    {post.Date && (
                      <span>{formatDateShort(post.Date)}</span>
                    )}
                    {post.Tags && post.Tags.length > 0 && (
                      <>
                        <span>路</span>
                        <span>{post.Tags[0].name}</span>
                      </>
                    )}
                    {post.Excerpt && (
                      <>
                        <span>路</span>
                        <span>{estimateReadingTime(post.Excerpt)}</span>
                      </>
                    )}
                  </div>
                  <p class="m-0 text-slate-600 text-base leading-relaxed line-clamp-3">
                    {post.Excerpt}
                  </p>
                </div>
                <div class="flex justify-end">
                  <PostTags post={post} enableLink={true} />
                </div>
              </div>
            </article>
          ))}
        </div>
      )
    }

    <footer class="py-8 px-8 border-t border-slate-200 text-center">
      <Pagination currentPage={1} numberOfPages={numberOfPages} tag="" />
    </footer>
  </div>

  <div slot="aside" class="flex flex-col gap-3">
    <!-- Advertisement 1 -->
    <!-- <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-lg p-6 relative overflow-hidden">
      <div class="absolute -top-1/2 -right-1/2 w-full h-full bg-white/10 rounded-full rotate-45"></div>
      <div class="relative z-10">
        <div class="flex justify-between items-center mb-4">
          <div class="font-bold text-xl">WIZ</div>
          <div class="bg-white/20 px-2 py-1 rounded text-xs font-medium">Gartner</div>
        </div>
        <h3 class="m-0 mb-2.5 text-lg font-semibold">2025 Gartner Market Guide for CNAPP</h3>
        <p class="m-0 mb-5 text-sm opacity-90">Wiz named a Representative Vendor</p>
        <button class="bg-white text-indigo-500 border-0 px-5 py-2.5 rounded-md font-semibold cursor-pointer transition-transform hover:-translate-y-0.5">Download now</button>
      </div>
    </div> -->
	    <!-- Newsletter Subscription Banner -->


    <!-- Call to Action -->
    <!-- <div class="bg-blue-600 text-white rounded-lg p-6 text-center">
      <div class="cta-content">
        <div class="text-4xl mb-4"></div>
        <h3 class="m-0 mb-2.5 text-lg font-semibold">Share your cybersecurity experience and expertise.</h3>
        <p class="m-0 text-sm opacity-90">Join our community of security professionals</p>
      </div>
    </div> -->

  </div>
</Layout>


