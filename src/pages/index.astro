---
import { Image } from 'astro:assets'
import { NUMBER_OF_POSTS_PER_PAGE } from '../server-constants.ts'
import ImageWithBlur from '../components/ImageWithBlur.astro'
import {
  getPosts,
  getRankedPosts,
  getAllTags,
  getFeaturedPost,
  getTopPosts,
} from '../lib/notion/client.ts'
import Layout from '../layouts/Layout.astro'
import NoContents from '../components/NoContents.astro'
import PostDate from '../components/PostDate.astro'
import PostTags from '../components/PostTags.astro'
import PostTitle from '../components/PostTitle.astro'
import PostFeaturedImage from '../components/PostFeaturedImage.astro'
import PostExcerpt from '../components/PostExcerpt.astro'
import ReadMoreLink from '../components/ReadMoreLink.astro'
import BlogPostsLink from '../components/BlogPostsLink.astro'
import BlogTagsLink from '../components/BlogTagsLink.astro'
import { getPostLink } from '../lib/blog-helpers.ts'
import { getImageFromNotionUrl } from '../lib/image-helpers.ts'

const labels = {
  categories: 'Kategorias',
}
const [posts, rankedPosts, tags, featuredPost, topPosts] = await Promise.all([
  getPosts(NUMBER_OF_POSTS_PER_PAGE),
  getRankedPosts(),
  getAllTags(),
  getFeaturedPost(),
  getTopPosts(4),
])

// Load featured post image if available
let featuredPostImage = null
if (featuredPost?.FeaturedImage?.Url) {
  if (import.meta.env.DEV) {
    featuredPostImage = featuredPost.FeaturedImage.Url
  } else {
    const imported = getImageFromNotionUrl(new URL(featuredPost.FeaturedImage.Url))
    featuredPostImage = imported || featuredPost.FeaturedImage.Url
  }
}

// Helper function to format date as "12 Jul 2025"
function formatDateShort(date: string): string {
  const dt = new Date(date)
  const months = ['Jan', 'Feb', 'Mar', 'Abr', 'Maiu', 'Jun', 'Jul', 'Ago', 'Set', 'Otu', 'Nov', 'Diz']
  const day = dt.getDate()
  const month = months[dt.getMonth()]
  const year = dt.getFullYear()
  return `${day} ${month} ${year}`
}

// Helper function to estimate reading time (words per minute = 200)
function estimateReadingTime(excerpt: string): string {
  const words = excerpt.split(/\s+/).length
  const minutes = Math.max(1, Math.ceil(words / 200))
  return `${minutes} min`
}
---

<Layout title="Ligadu" description="Artigus di siensia i saudi" path="/" ogImage="">
  <!-- Featured Section - Above main and aside -->
  {
    (featuredPost || topPosts.length > 0) && (
      <section slot="featured" class="mb-12 px-5 py-8 max-sm:px-2.5 max-sm:py-5" style="max-width: 1200px; margin: 0 auto; width: 100%;">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Main Featured Article -->
          {
            featuredPost && (
              <div class="md:col-span-2 lg:col-span-2">
                <a href={getPostLink(featuredPost.Slug)} class="block group">
                  <div class="relative overflow-hidden rounded-lg mb-4 aspect-[16/10] bg-slate-200">
                    {
                      featuredPostImage ? (
                        <div class="group-hover:scale-105 transition-transform duration-300">
                          <ImageWithBlur
                            src={featuredPostImage}
                            alt={featuredPost.Title}
                            width={typeof featuredPostImage === 'string' ? undefined : featuredPostImage.width}
                            height={typeof featuredPostImage === 'string' ? undefined : featuredPostImage.height}
                            loading="eager"
                            aspectRatio="16/10"
                            class="rounded-lg"
                          />
                        </div>
                      ) : (
                        <div class="w-full h-full flex items-center justify-center bg-slate-300">
                          <svg class="w-16 h-16 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                          </svg>
                        </div>
                      )
                    }
                  </div>
                  <div class="space-y-3">
                    <div class="flex items-center gap-2 text-xs text-slate-500 uppercase tracking-wide">
                      <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded font-semibold">Sta Ligadu</span>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-900 group-hover:text-blue-600 transition-colors leading-tight">
                      {featuredPost.Title}
                    </h2>
                    <div class="flex items-center gap-1.5 text-sm text-slate-400">
                      {featuredPost.Date && (
                        <span>{formatDateShort(featuredPost.Date)}</span>
                      )}
                      {featuredPost.Tags && featuredPost.Tags.length > 0 && (
                        <>
                          <span>·</span>
                          <span>{featuredPost.Tags[0].name}</span>
                        </>
                      )}
                      {featuredPost.Excerpt && (
                        <>
                          <span>·</span>
                          <span>{estimateReadingTime(featuredPost.Excerpt)}</span>
                        </>
                      )}
                    </div>
                    {
                      featuredPost.Excerpt && (
                        <p class="text-slate-600 text-base leading-relaxed line-clamp-3">
                          {featuredPost.Excerpt}
                        </p>
                      )
                    }
                  </div>
                </a>
              </div>
            )
          }

          <!-- Top Stories -->
          {
            topPosts.length > 0 && (
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Artigus distakadu</h3>
                {
                  topPosts.map((post) => (
                    <a href={getPostLink(post.Slug)} class="block group">
                      <div class="flex gap-3">
                        {post.FeaturedImage && post.FeaturedImage.Url && (
                          <div class="w-24 h-16 flex-shrink-0 rounded-md overflow-hidden">
                            <div class="w-full h-full group-hover:scale-105 transition-transform duration-300">
                              <PostFeaturedImage post={post} />
                            </div>
                          </div>
                        )}
                        <div class="flex-1 min-w-0">
                          <h4 class="text-base font-bold text-slate-900 group-hover:text-blue-600 transition-colors leading-snug line-clamp-2 mb-1">
                            {post.Title}
                          </h4>
                          <div class="flex items-center gap-1.5 text-xs text-slate-500">
                            {post.Date && (
                              <span>{formatDateShort(post.Date)}</span>
                            )}
                            {post.Tags && post.Tags.length > 0 && (
                              <>
                                <span>·</span>
                                <span>{post.Tags[0].name}</span>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    </a>
                  ))
                }
              </div>
            )
          }
        </div>

        <!-- Latest Articles Section - Same width as hero -->
        {
          posts.length > 0 && (
            <div class="mt-12">
              <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6">Kes últimu artigu i stória</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {posts.map((post) => (
                  <article class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                    <a href={getPostLink(post.Slug)} class="block">
                      {post.FeaturedImage && post.FeaturedImage.Url && (
                        <div class="aspect-[16/10] overflow-hidden">
                          <div class="w-full h-full group-hover:scale-105 transition-transform duration-300">
                            <PostFeaturedImage post={post} />
                          </div>
                        </div>
                      )}
                      <div class="p-4">
                        <h1 class="m-0 text-lg font-bold text-slate-900 leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">
                          {post.Title}
                        </h1>
                        <div class="flex items-center gap-1.5 text-xs text-slate-500 mt-2">
                          {post.Date && (
                            <span>{formatDateShort(post.Date)}</span>
                          )}
                          {post.Tags && post.Tags.length > 0 && (
                            <>
                              <span>·</span>
                              <span>{post.Tags[0].name}</span>
                            </>
                          )}
                          {post.Excerpt && (
                            <>
                              <span>·</span>
                              <span>{estimateReadingTime(post.Excerpt)}</span>
                            </>
                          )}
                        </div>
                        <p class="m-0 mt-2 text-slate-600 text-sm leading-relaxed line-clamp-2">
                          {post.Excerpt}
                        </p>
                        <div class="flex justify-start mt-3">
                          <PostTags post={post} enableLink={true} />
                        </div>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </div>
          )
        }
      </section>
    )
  }

  <!-- Empty main slot since content is in featured section -->
  <div slot="main" class="hidden"></div>
</Layout>


