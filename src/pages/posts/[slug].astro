---
import * as interfaces from '../../lib/interfaces.ts'
import {
  getPosts,
  getAllPosts,
  getRankedPosts,
  getPostBySlug,
  getPostsByTag,
  getBlock,
  getAllTags,
  getAllBlocksByBlockId,
  downloadFile,
} from '../../lib/notion/client.ts'
import {
  getPostLink,
  filePath,
  extractTargetBlocks,
  getDateStr,
} from '../../lib/blog-helpers.ts'
import Layout from '../../layouts/Layout.astro'
import PostDate from '../../components/PostDate.astro'
import PostTags from '../../components/PostTags.astro'
import PostTitle from '../../components/PostTitle.astro'
import PostBody from '../../components/PostBody.astro'
import PostRelativeLink from '../../components/PostRelativeLink.astro'
import BlogPostsLink from '../../components/BlogPostsLink.astro'
import BlogTagsLink from '../../components/BlogTagsLink.astro'
import NoContents from '../../components/NoContents.astro'

export async function getStaticPaths() {
  const posts = await getAllPosts()
  return posts.map((post: interfaces.Post) => ({ params: { slug: post.Slug } }))
}

const { slug } = Astro.params

const post = await getPostBySlug(slug)
if (!post) {
  throw new Error(`Post not found. slug: ${slug}`)
}

const [blocks, allPosts, rankedPosts, recentPosts, tags, postsHavingSameTag] =
  await Promise.all([
    getAllBlocksByBlockId(post.PageId),
    getAllPosts(),
    getRankedPosts(),
    getPosts(5),
    getAllTags(),
    getPostsByTag(post.Tags[0]?.name, 6),
  ])

const fileAtacchedBlocks = extractTargetBlocks('image', blocks)
  .concat(extractTargetBlocks('file', blocks))
  .filter((block) => {
    if (!block) {
      return false
    }
    const imageOrFile = block.Image || block.File
    return imageOrFile && imageOrFile.File && imageOrFile.File.Url
  })

// Download files
await Promise.all(
  fileAtacchedBlocks
    .map(async (block) => {
      const expiryTime = (block.Image || block.File).File.ExpiryTime
      if (Date.parse(expiryTime) > Date.now()) {
        return Promise.resolve(block)
      }
      return getBlock(block.Id)
    })
    .map((promise) =>
      promise.then((block) => {
        let url!: URL
        try {
          url = new URL((block.Image || block.File).File.Url)
        } catch {
          console.log('Invalid file URL: ', (block.Image || block.File)?.File?.Url)
          return Promise.reject()
        }
        return Promise.resolve(url)
      })
    )
    .map((promise) => promise.then(downloadFile))
)

const currentPostIndex = allPosts.findIndex((post) => post.Slug === slug)
const prevPost = allPosts[currentPostIndex + 1]
const nextPost = allPosts[currentPostIndex - 1]

let ogImage = ''
if (post.FeaturedImage && post.FeaturedImage.Url) {
  ogImage = new URL(filePath(new URL(post.FeaturedImage.Url)), Astro.site)
}

// Helper function to format date as "12 Jul 2025"
function formatDateShort(date: string): string {
  const dt = new Date(date)
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
  const day = dt.getDate()
  const month = months[dt.getMonth()]
  const year = dt.getFullYear()
  return `${day} ${month} ${year}`
}

// Helper function to estimate reading time (words per minute = 200)
function estimateReadingTime(excerpt: string): string {
  const words = excerpt.split(/\s+/).length
  const minutes = Math.max(1, Math.ceil(words / 200))
  return `${minutes} min`
}
---

<Layout
  title={}
  description={post.Excerpt}
  path={getPostLink(post.Slug)}
  ogImage={ogImage}
>
  <div slot="main" class="p-0">
    <div class="mx-auto mb-10">
      <header class="pb-5">
        <PostDate post={post} />
        <PostTags post={post} />
        <PostTitle post={post} enableLink={false} />
      </header>
      
      <PostBody blocks={blocks} />
      
      <PostTags post={post} />

      <footer class="border-t border-dashed border-slate-400 mx-auto pt-10 max-sm:mb-10">
        <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
      </footer>
    </div>
  </div>

  <div slot="aside" class="flex flex-col gap-3">
    <div class="rounded-lg p-5">
      <h3 class="m-0 mb-4 text-lg font-semibold text-slate-800 border-b-2 border-blue-600 pb-2">Artigus di mesmu tipu</h3>
      {
        postsHavingSameTag.filter((p: interfaces.Post) => p.Slug !== post.Slug).length === 0 ? (
          <NoContents contents={[]} />
        ) : (
          <div class="space-y-4">
            {postsHavingSameTag
              .filter((p: interfaces.Post) => p.Slug !== post.Slug)
              .slice(0, 5)
              .map((relatedPost: interfaces.Post) => (
                <a 
                  href={getPostLink(relatedPost.Slug)} 
                  class="block group bg-white border border-slate-200 rounded-lg p-3 hover:shadow-md hover:border-blue-300 transition-all"
                >
                  <div class="space-y-2">
                    {relatedPost.FeaturedImage && relatedPost.FeaturedImage.Url && (
                      <div class="w-full aspect-video rounded-md overflow-hidden bg-slate-200">
                        <img
                          src={import.meta.env.DEV ? relatedPost.FeaturedImage.Url : filePath(new URL(relatedPost.FeaturedImage.Url))}
                          alt={relatedPost.Title}
                          class="w-full h-full object-cover"
                        />
                      </div>
                    )}
                    <h4 class="m-0 text-sm font-bold text-slate-900 leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">
                      {relatedPost.Title}
                    </h4>
                    {relatedPost.Excerpt && (
                      <p class="m-0 text-xs text-slate-600 leading-relaxed line-clamp-2">
                        {relatedPost.Excerpt}
                      </p>
                    )}
                  </div>
                </a>
              ))}
          </div>
        )
      }
    </div>
    
    <div class="rounded-lg p-5">
      <h3 class="m-0 mb-4 text-lg font-semibold text-slate-800 border-b-2 border-blue-600 pb-2">Otus artigu pa lê</h3>
      {
        rankedPosts.length === 0 ? (
          <NoContents contents={[]} />
        ) : (
          <div class="space-y-4">
            {rankedPosts
              .slice(0, 5)
              .map((rankedPost: interfaces.Post) => (
                <a 
                  href={getPostLink(rankedPost.Slug)} 
                  class="block group bg-white border border-slate-200 rounded-lg p-3 hover:shadow-md hover:border-blue-300 transition-all"
                >
                  <div class="space-y-2">
                    {rankedPost.FeaturedImage && rankedPost.FeaturedImage.Url && (
                      <div class="w-full aspect-video rounded-md overflow-hidden bg-slate-200">
                        <img
                          src={import.meta.env.DEV ? rankedPost.FeaturedImage.Url : filePath(new URL(rankedPost.FeaturedImage.Url))}
                          alt={rankedPost.Title}
                          class="w-full h-full object-cover"
                        />
                      </div>
                    )}
                    <h4 class="m-0 text-sm font-bold text-slate-900 leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">
                      {rankedPost.Title}
                    </h4>
                    {rankedPost.Excerpt && (
                      <p class="m-0 text-xs text-slate-600 leading-relaxed line-clamp-2">
                        {rankedPost.Excerpt}
                      </p>
                    )}
                  </div>
                </a>
              ))}
          </div>
        )
      }
    </div>
    
    <div class="rounded-lg p-5">
      <h3 class="m-0 mb-4 text-lg font-semibold text-slate-800 border-b-2 border-blue-600 pb-2">Kes últimu artigu i stória</h3>
      {
        recentPosts.length === 0 ? (
          <NoContents contents={[]} />
        ) : (
          <div class="space-y-4">
            {recentPosts
              .slice(0, 5)
              .map((recentPost: interfaces.Post) => (
                <a 
                  href={getPostLink(recentPost.Slug)} 
                  class="block group bg-white border border-slate-200 rounded-lg p-3 hover:shadow-md hover:border-blue-300 transition-all"
                >
                  <div class="space-y-2">
                    {recentPost.FeaturedImage && recentPost.FeaturedImage.Url && (
                      <div class="w-full aspect-video rounded-md overflow-hidden bg-slate-200">
                        <img
                          src={import.meta.env.DEV ? recentPost.FeaturedImage.Url : filePath(new URL(recentPost.FeaturedImage.Url))}
                          alt={recentPost.Title}
                          class="w-full h-full object-cover"
                        />
                      </div>
                    )}
                    <h4 class="m-0 text-sm font-bold text-slate-900 leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">
                      {recentPost.Title}
                    </h4>
                    {recentPost.Excerpt && (
                      <p class="m-0 text-xs text-slate-600 leading-relaxed line-clamp-2">
                        {recentPost.Excerpt}
                      </p>
                    )}
                  </div>
                </a>
              ))}
          </div>
        )
      }
    </div>
    
    <div class="rounded-lg p-5">
      <h3 class="m-0 mb-4 text-lg font-semibold text-slate-800 border-b-2 border-blue-600 pb-2">Tipus di artigu</h3>
      <BlogTagsLink heading="" tags={tags} />
    </div>
  </div>
</Layout>
