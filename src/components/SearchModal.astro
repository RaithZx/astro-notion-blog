---
---

<div class="search-modal-container">
  <div class="overlay"></div>

  <div class="search-modal">
    <div class="search-prompt">
      <input type="text" placeholder="Piskiza..." aria-label="Piskiza" />
      <div class="search-hints">
        <span class="hint-item"><kbd>↑↓</kbd> Naviga</span>
        <span class="hint-item"><kbd>Enter</kbd> Abri</span>
        <span class="hint-item"><kbd>Esc</kbd> Fecha</span>
      </div>
    </div>
    <div class="search-result">
      <div class="search-loading" style="display: none;">
        <div class="loading-spinner"></div>
        <span>Karrega...</span>
      </div>
      <div class="search-empty" style="display: none;">
        <p>Nunka rezultadu enkontradu.</p>
      </div>
      <ul>
      </ul>
    </div>
  </div>
</div>

<style>
  div.search-modal-container {
    display: none;
  }

  div.overlay {
    z-index: 99;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  div.search-modal {
    z-index: 100;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    border-radius: 12px;
    background-color: var(--bg);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  @media (max-width: 640px) {
    div.search-modal {
      top: 10%;
      transform: translate(-50%, 0);
      width: 95%;
      max-height: 85vh;
      border-radius: 8px;
    }
  }

  div.search-prompt {
    margin: 0;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--hr-border);
  }
  div.search-prompt input {
    width: 100%;
    border: 0px solid transparent;
    padding: 0.75rem;
    background-color: var(--input-bg);
    color: var(--fg);
    font-size: 1.1rem;
    line-height: 1.5rem;
    border-radius: 6px;
    outline: none;
  }
  div.search-prompt input:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
  
  .search-hints {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--hr-border);
    flex-wrap: wrap;
  }
  
  .hint-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: #94a3b8;
  }
  
  .hint-item kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.5rem;
    height: 1.25rem;
    padding: 0 0.25rem;
    background-color: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 0.25rem;
    font-size: 0.6875rem;
    font-family: monospace;
    color: #475569;
  }
  
  @media (max-width: 640px) {
    .search-hints {
      gap: 0.75rem;
    }
    
    .hint-item {
      font-size: 0.6875rem;
    }
  }

  div.search-result {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }
  div.search-result ul {
    list-style: none;
    margin: 0;
    padding: 0.5rem;
  }
  
  .search-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    color: #64748b;
  }
  
  .search-loading .loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 3px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  
  .search-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: #64748b;
    text-align: center;
  }
  
  .search-empty p {
    margin: 0;
    font-size: 0.875rem;
  }
  div.search-result ul > :global(li) {
  }
  div.search-result ul > :global(li > a) {
    display: block;
    padding: 0.4rem 0.6rem;
    border-radius: var(--radius);
  }
  div.search-result ul > :global(li.selected > a) {
    background-color: #eff6ff;
    border-left: 3px solid #3b82f6;
  }
  
  div.search-result ul > :global(li > a:hover) {
    background-color: #f8fafc;
  }

  div.search-result :global(div.search-result-title) {
    padding: 0.1rem 0;
    color: var(--fg);
    font-size: 1.1rem;
    line-height: 1.2rem;
    font-weight: bold;
  }
  div.search-result :global(div.search-result-description) {
    margin: 0 0 0.1rem;
    color: var(--fg);
    font-size: 0.9rem;
    line-height: 1.2rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    let feedItems = []
    let fetched = false

    async function openModal() {
      document.querySelector('.search-modal-container').style.display = 'block'
      document.querySelector('.search-prompt input').focus()

      if (!fetched) {
        showLoading()
        try {
          await fetchRSS()
        } catch (error) {
          showError('Erru durante karga di dados.')
        } finally {
          hideLoading()
        }
      }
      searchAndRender()
    }
    
    function showLoading() {
      const loading = document.querySelector('.search-loading')
      const empty = document.querySelector('.search-empty')
      const ul = document.querySelector('.search-result ul')
      if (loading) loading.style.display = 'flex'
      if (empty) empty.style.display = 'none'
      if (ul) ul.style.display = 'none'
    }
    
    function hideLoading() {
      const loading = document.querySelector('.search-loading')
      const ul = document.querySelector('.search-result ul')
      if (loading) loading.style.display = 'none'
      if (ul) ul.style.display = 'block'
    }
    
    function showError(message) {
      const empty = document.querySelector('.search-empty')
      const ul = document.querySelector('.search-result ul')
      if (empty) {
        empty.querySelector('p').textContent = message
        empty.style.display = 'block'
      }
      if (ul) ul.style.display = 'none'
    }

    function closeModal() {
      document.querySelector('.search-modal-container').style.display = 'none'
    }

    function handleKeydown(event) {
      if (event.keyCode === 13) {
        // Enter
        select()
      } else if (event.keyCode === 27) {
        // ESC
        closeModal()
      } else if (event.keyCode === 38) {
        // Up
        selectUp(event)
      } else if (event.keyCode === 40) {
        // Down
        selectDown(event)
      } else {
        searchAndRender()
      }
    }

    function select() {
      const a = document.querySelector('.search-result ul > li.selected a')
      a.click()
    }

    function selectFirst() {
      const li = document.querySelector('.search-result ul > li:first-child')
      if (li) {
        li.classList.add('selected')
      }
    }

    function selectUp(event) {
      event.preventDefault()

      const ul = document.querySelector('.search-result ul')
      const selected = ul.querySelector('.selected')
      if (selected) {
        selected.classList.remove('selected')

        if (selected.previousElementSibling) {
          selected.previousElementSibling.classList.add('selected')
        } else {
          ul.lastElementChild.classList.add('selected')
        }
      } else {
        ul.lastElementChild.classList.add('selected')
      }
    }

    function selectDown(event) {
      event.preventDefault()

      const ul = document.querySelector('.search-result ul')
      const selected = ul.querySelector('.selected')
      if (selected) {
        selected.classList.remove('selected')

        if (selected.nextElementSibling) {
          selected.nextElementSibling.classList.add('selected')
        } else {
          ul.firstElementChild.classList.add('selected')
        }
      } else {
        ul.firstElementChild.classList.add('selected')
      }
    }

    function handleMouseover(event) {
      Array.from(event.target.closest('ul').children).forEach((element) => {
        element.classList.remove('selected')
      })
      event.target.closest('li').classList.add('selected')
    }

    function searchAndRender() {
      const text = document.querySelector('.search-prompt input').value.trim()

      if (text !== '') {
        const results = search(text)
        renderResults(results)
      } else {
        renderResults(feedItems)
      }

      selectFirst()
    }

    function search(query) {
      const results = []
      feedItems.forEach((item) => {
        if (item.title.includes(query) || item?.description?.includes(query)) {
          results.push(item)
        }
      })
      return results
    }

    function renderResults(results) {
      const ul = document.querySelector('.search-result ul')
      const empty = document.querySelector('.search-empty')
      ul.innerHTML = ''
      
      if (results.length === 0) {
        if (empty) empty.style.display = 'block'
        return
      }
      
      if (empty) empty.style.display = 'none'

      results.forEach((item) => {
        const li = document.createElement('li')
        const a = document.createElement('a')
        const title = document.createElement('div')
        const description = document.createElement('div')

        title.classList.add('search-result-title')
        title.textContent = item.title
        description.classList.add('search-result-description')
        description.textContent = item.description
        a.href = item.link

        li.addEventListener('mouseover', handleMouseover)

        a.appendChild(title)
        a.appendChild(description)
        li.appendChild(a)
        ul.appendChild(li)
      })
    }

    async function fetchRSS() {
      const url = new URL(location.href)
      const port = url.port ? `:${url.port}` : ''

      const res = await fetch(
        `${url.protocol}//${url.hostname}${port}/feed`
      )
      if (res.status !== 200) {
        console.log(res.status)
        throw new Error('Failed to fetch RSS feed')
      }

      const body = await res.text()

      const parser = new DOMParser()
      const xml = parser.parseFromString(body, 'text/xml')

      Array.from(xml.getElementsByTagName('item')).forEach((item) => {
        const title = item.getElementsByTagName('title')[0].textContent
        const link = item.getElementsByTagName('link')[0].textContent
        const description =
          item.getElementsByTagName('description')[0]?.textContent
        const pubDate = item.getElementsByTagName('pubDate')[0].textContent

        feedItems.push({
          title,
          link,
          description,
          pubDate,
        })
      })

      fetched = true
    }

    Array.from(document.getElementsByClassName('open-search-modal')).forEach(
      (element) => {
        element.addEventListener('click', openModal)
      }
    )
    document
      .getElementsByClassName('overlay')[0]
      .addEventListener('click', closeModal)
    document.addEventListener('keydown', handleKeydown)
  })
</script>
