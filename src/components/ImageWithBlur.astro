---
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'

export interface Props {
  src: ImageMetadata | string
  alt: string
  width?: number
  height?: number
  class?: string
  loading?: 'lazy' | 'eager'
  aspectRatio?: string
}

const { 
  src, 
  alt, 
  width, 
  height, 
  class: className = '',
  loading = 'lazy',
  aspectRatio
} = Astro.props

const imageId = `img-${Math.random().toString(36).substr(2, 9)}`
const isString = typeof src === 'string'
---

<div class={`image-blur-wrapper ${className}`} style={aspectRatio ? `aspect-ratio: ${aspectRatio};` : ''}>
  <!-- Blur placeholder/skeleton -->
  <div class="image-blur-placeholder" data-placeholder-id={imageId}>
    <div class="skeleton-shimmer"></div>
  </div>
  
  <!-- Actual image -->
  <div class="image-container" data-container-id={imageId}>
    {isString ? (
      <img
        src={src}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        class="image-content"
        data-image-id={imageId}
      />
    ) : (
      <Image
        src={src}
        alt={alt}
        width={width || src.width}
        height={height || src.height}
        loading={loading}
        class="image-content"
        data-image-id={imageId}
      />
    )}
  </div>
</div>

<style>
  .image-blur-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    background-color: #e2e8f0;
  }

  .image-blur-placeholder {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      #e2e8f0 0%,
      #f1f5f9 50%,
      #e2e8f0 100%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    z-index: 1;
    transition: opacity 0.5s ease-out;
  }

  .image-blur-placeholder.loaded {
    opacity: 0;
    pointer-events: none;
  }

  .image-container {
    position: relative;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.5s ease-in;
  }

  .image-container.loaded {
    opacity: 1;
  }

  .image-content {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }
</style>

<script define:vars={{ imageId }}>
  // Handle image load events for both regular img and Astro Image components
  (function() {
    const container = document.querySelector(`[data-container-id="${imageId}"]`)
    const placeholder = document.querySelector(`[data-placeholder-id="${imageId}"]`)
    const img = container?.querySelector('img')
    
    if (img && container && placeholder) {
      const handleLoad = () => {
        container.classList.add('loaded')
        placeholder.classList.add('loaded')
      }
      
      // Check if already loaded
      if (img.complete && img.naturalHeight !== 0) {
        handleLoad()
      } else {
        img.addEventListener('load', handleLoad)
        img.addEventListener('error', handleLoad)
      }
    }
  })()
</script>
