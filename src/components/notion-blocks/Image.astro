---
import { Image as AstroImage } from 'astro:assets'
import { ENABLE_LIGHTBOX } from '../../server-constants.ts'
import * as interfaces from '../../lib/interfaces'
import { getImageFromNotionUrl } from '../../lib/image-helpers'
import Caption from './Caption.astro'

export interface Props {
  block: interfaces.Block
}

const { block } = Astro.props

if (!block.Image) {
  return null
}

let imageModule: any = null
let imageUrl = ''
let altText = ''

// Extract alt text from caption
if (block.Image.Caption && block.Image.Caption.length > 0) {
  altText = block.Image.Caption
    .map((rt) => rt.PlainText || rt.Text?.Content || '')
    .join(' ')
    .trim()
}

if (!altText) {
  altText = 'Image in a image block'
}

// Handle External (remote) vs File (downloaded) images
if (block.Image.External) {
  imageUrl = block.Image.External.Url
} else if (block.Image.File) {
  if (import.meta.env.DEV) {
    // In dev, use URL directly
    imageUrl = block.Image.File.Url
  } else {
    // In production, use pre-loaded image map for optimized images
    const imported = getImageFromNotionUrl(new URL(block.Image.File.Url))
    if (imported) {
      imageModule = imported
    } else {
      // Fallback to URL if lookup fails
      imageUrl = block.Image.File.Url
    }
  }
}
---

<figure class="image">
  {
    (imageModule || imageUrl) && (
      <div>
        <div>
          {ENABLE_LIGHTBOX ? (
            <a 
              data-fslightbox 
              href={imageModule ? (imageModule as any).src : imageUrl} 
              data-type="image"
            >
              {imageModule ? (
                <AstroImage 
                  src={imageModule} 
                  alt={altText}
                  loading="lazy"
                />
              ) : (
                <img src={imageUrl} alt={altText} loading="lazy" />
              )}
            </a>
          ) : (
            imageModule ? (
              <AstroImage 
                src={imageModule} 
                alt={altText}
                loading="lazy"
              />
            ) : (
              <img src={imageUrl} alt={altText} loading="lazy" />
            )
          )}
        </div>
        <Caption richTexts={block.Image.Caption} />
      </div>
    )
  }
</figure>

<style>
  .image {
    display: flex;
    margin: 0.2rem auto 0;
  }
  .image > div {
    margin: 0 auto;
  }
  .image > div > div {
  }
  .image > div > div img {
    display: block;
    max-width: 100%;
  }
</style>
